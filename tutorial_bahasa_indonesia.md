
# Panduan Setup Database Supabase - NOVA

Gunakan skrip SQL di bawah ini pada bagian **SQL Editor** di Dashboard Supabase Anda untuk menyiapkan infrastruktur database.

## 1. Skrip Konfigurasi Tabel & Keamanan

```sql
-- Hapus tabel jika sudah ada (opsional, untuk reset)
-- DROP TABLE IF EXISTS public.tickets;
-- DROP TABLE IF EXISTS public.events;
-- DROP TABLE IF EXISTS public.profiles;

-- 1. TABEL PROFILES (Sinkron dengan Supabase Auth)
CREATE TABLE public.profiles (
  id UUID REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
  full_name TEXT,
  email TEXT,
  role TEXT DEFAULT 'user' CHECK (role IN ('user', 'admin')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. TABEL EVENTS (Daftar Acara)
CREATE TABLE public.events (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  type TEXT CHECK (type IN ('Seminar', 'Workshop', 'Conference')),
  event_date DATE NOT NULL,
  event_time TEXT NOT NULL,
  price NUMERIC(12, 2) NOT NULL DEFAULT 0,
  image_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. TABEL TICKETS (Manajemen Invoice & E-Ticket)
CREATE TABLE public.tickets (
  id TEXT PRIMARY KEY, -- Format: INV-XXXXXX
  user_id UUID REFERENCES auth.users NOT NULL,
  event_id BIGINT REFERENCES public.events NOT NULL,
  quantity INT NOT NULL DEFAULT 1,
  total_price NUMERIC(12, 2) NOT NULL,
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'paid')),
  qr_code TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. KEAMANAN (Row Level Security - RLS)
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.events ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.tickets ENABLE ROW LEVEL SECURITY;

-- Kebijakan untuk Events (Semua orang bisa melihat)
CREATE POLICY "Enable read access for all users" ON public.events FOR SELECT USING (true);
CREATE POLICY "Enable insert for admins only" ON public.events FOR INSERT WITH CHECK (
  EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin')
);
CREATE POLICY "Enable delete for admins only" ON public.events FOR DELETE USING (
  EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin')
);

-- Kebijakan untuk Profiles (User hanya bisa melihat profil sendiri)
CREATE POLICY "Users can view own profile" ON public.profiles FOR SELECT USING (auth.uid() = id);

-- Kebijakan untuk Tickets (User hanya bisa akses tiket sendiri)
CREATE POLICY "Users can view own tickets" ON public.tickets FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own tickets" ON public.tickets FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own tickets" ON public.tickets FOR UPDATE USING (auth.uid() = user_id);

-- 5. AUTOMATIC PROFILE TRIGGER (Sangat Penting!)
-- Fungsi ini akan dijalankan otomatis saat user melakukan Register di App
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, full_name, email, role)
  VALUES (
    new.id, 
    new.raw_user_meta_data->>'full_name', 
    new.email, 
    'user' -- Default role saat mendaftar adalah user
  );
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger untuk menjalankan fungsi di atas
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- 6. DATA CONTOH (Dummy Data)
INSERT INTO public.events (title, description, type, event_date, event_time, price, image_url) VALUES 
('Future of AI in Education', 'Exploring how artificial intelligence transforms learning environments.', 'Seminar', '2025-05-15', '09:00', 150000, 'https://images.unsplash.com/photo-1485827404703-89b55fcc595e?q=80&w=400'),
('Web Development Bootcamp', 'Intensive workshop on modern front-end technologies.', 'Workshop', '2025-05-20', '13:00', 250000, 'https://images.unsplash.com/photo-1498050108023-c5249f4df085?q=80&w=400'),
('Global Health Conference', 'International gathering of health experts and researchers.', 'Conference', '2025-06-10', '08:00', 500000, 'https://images.unsplash.com/photo-1505751172107-573220ad4bca?q=80&w=400');
```

## 2. Cara Membuat Akun Admin
Setelah Anda mendaftar melalui aplikasi menggunakan email `admin@nova.id`, Anda harus mengubah role user tersebut secara manual di database agar bisa mengakses **Admin Panel**:

1. Pergi ke Dashboard Supabase -> **Table Editor**.
2. Pilih tabel `profiles`.
3. Cari baris dengan email Anda, ubah kolom `role` dari `user` menjadi `admin`.
4. Klik **Save**.
5. Refresh aplikasi NOVA Anda, dan menu "Admin Panel" akan muncul di navigasi.

---

## 3. Catatan untuk Netlify Deployment
Pastikan Anda telah memasukkan Environment Variables berikut di Settings Netlify:
- `VITE_SUPABASE_URL`: Diambil dari Supabase Project Settings -> API.
- `VITE_SUPABASE_ANON_KEY`: Diambil dari Supabase Project Settings -> API.
